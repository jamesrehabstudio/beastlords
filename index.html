<!doctype html>
<html>
<head>
	<title>BEAST LORDS | A Javascript game</title>
	<meta name="description" content="A Javascript game using canvas" />
	<link rel="stylesheet" href="css/style.css">
	
	<script src="js/jquery.js"></script>
	<script src="js/game.js" type="text/javascript"></script>
	<script src="js/gl.js" type="text/javascript"></script>
	<!--<script src="js/queue.js" type="text/javascript"></script>-->
	<script src="maps/map.js" type="text/javascript"></script>
	<script src="js/data.js" type="text/javascript"></script>
	<script src="js/polygons.js" type="text/javascript"></script>
	<script src="js/input.js" type="text/javascript"></script>
	<script src="js/platformer.js" type="text/javascript"></script>
	
	<script>
	window.onload = function() {
		window.dataManager = new DataManager();
		window.input = new Input();
		
		window.game = new Game( document.getElementById( 'game' ) );
		$(window).resize(function(x,y){
			game.resize(window.innerWidth, window.innerHeight);
		});
		$(window).trigger("resize");
		//game.buildPaths();
		loop();
	}
	</script>
	
	<script>
		if( window.location.hash == "#notrack" ) {
			window.ga = function(){};
		} else {
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

			ga('create', 'UA-36519880-3', 'auto');
			ga('send', 'pageview');
		}
	</script>
	
	<!-- SHADERS GO HERE!!! -->
	<script id="back-vertex-shader" type="x-shader/x-vertex">
		attribute vec2 a_position;
		attribute vec2 a_texCoord;
		uniform vec2 u_resolution;
		
		varying vec2 v_texCoord;
		
		void main() {
			//vec2 pos = a_position + u_camera - u_resolution * 0.5;
			//pos.x = pos.x - u_resolution.x;
			gl_Position = vec4(a_position, 0, 1);
			v_texCoord = a_texCoord;
		}
	</script>
	
	<script id="2d-vertex-shader" type="x-shader/x-vertex">
		attribute vec2 a_position;
		attribute vec2 a_texCoord;
		uniform vec2 u_resolution;
		uniform vec2 u_camera;
		
		varying vec2 v_texCoord;
		varying vec2 v_position;
		
		void main() {
			vec2 pos = a_position + u_camera - u_resolution * 0.5;
			//pos.y = u_resolution.y + pos.y*-1.0;
			pos.y = pos.y*-1.0;
			//pos.x = pos.x - u_resolution.x;
			gl_Position = vec4(pos/(u_resolution*0.5), 0, 1);
			v_texCoord = a_texCoord;
			v_position = a_position;
		}
	</script>
	
	<script id="2d-vertex-scale" type="x-shader/x-vertex">
		attribute vec2 a_position;
		attribute vec2 a_texCoord;
		uniform vec2 scale;
		uniform vec2 u_resolution;
		uniform vec2 u_camera;
		
		varying vec2 v_texCoord;
		varying vec2 v_position;
		
		void main() {
			vec2 pos = a_position * scale + u_camera - u_resolution * 0.5;
			//pos.y = u_resolution.y + pos.y*-1.0;
			pos.y = pos.y*-1.0;
			//pos.x = pos.x - u_resolution.x;
			gl_Position = vec4(pos/(u_resolution*0.5), 0, 1);
			v_texCoord = a_texCoord;
			v_position = a_position;
		}
	</script>

	<script id="2d-fragment-shader" type="x-shader/x-fragment">
		precision mediump float;
		uniform sampler2D u_image;
		varying vec2 v_texCoord;
		uniform vec4 u_color;
		
		void main() {
			gl_FragColor = u_color * texture2D(u_image, v_texCoord);
			//gl_FragColor = vec4(v_texCoord.x,v_texCoord.y,0,1.0);
		}
	</script>
	
	<script id="fragment-shifthue" type="x-shader/x-fragment">
		precision mediump float;
		uniform sampler2D u_image;
		varying vec2 v_texCoord;
		uniform float u_shift;
		
		vec3 rgb2hsv(vec3 c)
		{
			vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
			vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
			vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));

			float d = q.x - min(q.w, q.y);
			float e = 1.0e-10;
			return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
		}

		vec3 hsv2rgb(vec3 c)
		{
			vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
			vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
			return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
		}
		
		void main() {
			vec4 color = texture2D(u_image, v_texCoord);
			vec3 hsv = rgb2hsv(color.rgb);
			hsv.x = mod(hsv.x + u_shift, 1.0);
			vec3 rgb = hsv2rgb(hsv);
			gl_FragColor = vec4(rgb,color.a);
		}
	</script>
	
	<script id="fragment-greytocolor" type="x-shader/x-fragment">
		precision mediump float;
		uniform sampler2D u_image;
		varying vec2 v_texCoord;
		uniform vec4 u_color;
		
		void main() {
			vec4 color = texture2D(u_image, v_texCoord);
			if( abs((color.r+color.g+color.b)-color.r*3.0) < 0.04 ) {
				gl_FragColor = color * u_color;
			} else { 
				gl_FragColor = color;
			}
		}
	</script>
	
	<script id="fragment-heat" type="x-shader/x-fragment">
		precision mediump float;
		uniform sampler2D u_image;
		uniform float heat;
		varying vec2 v_texCoord;
		
		void main() {
			vec4 color = texture2D(u_image, v_texCoord);
			color.r = color.r * (1.0-heat) + heat;
			color.g = color.g * (1.0-heat) + heat * 0.4;
			color.b = color.b * (1.0-heat);
			gl_FragColor = color;
		}
	</script>
	
	<script id="2d-fragment-solid" type="x-shader/x-fragment">
		precision mediump float;
		uniform vec4 u_color;
		
		void main() {
			gl_FragColor = u_color;
		}
	</script>
	
	<script id="2d-fragment-lightbeam" type="x-shader/x-fragment">
		precision mediump float;
		uniform vec4 u_color;
		varying vec2 v_texCoord;
		
		void main() {
			vec4 color = u_color;
			color.a *= 1.0 - v_texCoord.y;
			gl_FragColor = color;
		}
	</script>
	
	<script id="2d-fragment-blur" type="x-shader/x-fragment">
		precision mediump float;
		uniform sampler2D u_image;
		uniform float blur;
		
		varying vec2 v_texCoord;
		varying vec2 v_position;
		
		void main() {
			vec4 color = texture2D(u_image, v_texCoord);
			vec4 u = texture2D(u_image, v_texCoord + vec2(0,-blur));
			vec4 d = texture2D(u_image, v_texCoord + vec2(0,blur));
			vec4 l = texture2D(u_image, v_texCoord + vec2(-blur,0));
			vec4 r = texture2D(u_image, v_texCoord + vec2(blur,0));
			
			if( v_position.y < 3.0 ) u = color;
			if( v_position.y > 14.0 ) d = color;
			if( v_position.x < 3.0 ) l = color;
			if( v_position.x > 14.0 ) r = color;
			
			float activeColors = 0.0;
			if( color.a > 0.1 ) activeColors++;
			if( u.a > 0.1 ) activeColors++;
			if( d.a > 0.1 ) activeColors++;
			if( l.a > 0.1 ) activeColors++;
			if( r.a > 0.1 ) activeColors++;
			
			color.r = (color.r + u.r + d.r + l.r + r.r) / activeColors;
			color.g = (color.g + u.g + d.g + l.g + r.g) / activeColors;
			color.b = (color.b + u.b + d.b + l.b + r.b) / activeColors;
			color.a = (color.a + u.a + d.a + l.a + r.a) / 5.0;
			
			//color.a = 1.0; color.r = v_position.x/16.0; color.g = v_position.y/16.0; color.b = 0.0;
			gl_FragColor = color;
		}
	</script>	
</head>
<body>
	<div class="fullscreen_wrap">
		<canvas id="game" width="256" height="240"></canvas>
	</div>
</body>